name: Refresh NFL Predictions

on:
  workflow_dispatch:
  schedule:
    - cron: "0 13 * * TUE" # Tuesdays at 13:00 UTC (08:00 ET)

env:
  PROJECT_ID: learned-pier-478122-p7
  GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/gcp-key.json

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt google-cloud-bigquery nflreadpy

      - name: Configure GCP credentials
        shell: bash
        run: |
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" > "$GOOGLE_APPLICATION_CREDENTIALS"

      - name: Backfill raw data for current season
        shell: bash
        run: |
          CURRENT_SEASON=$(date +%Y)
          python scripts/backfill_nfl_raw.py --project "$PROJECT_ID" --seasons "$CURRENT_SEASON" --replace

      - name: Build feature snapshots
        shell: bash
        run: |
          CURRENT_SEASON=$(date +%Y)
          python scripts/build_feature_snapshots.py --project "$PROJECT_ID" --seasons "$CURRENT_SEASON" --replace

      - name: Generate predictions for upcoming week
        shell: bash
        run: |
          python src/pipeline/refresh_nfl.py --project "$PROJECT_ID" --model-version v1

      - name: Sync predictions to Supabase
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          supabaseDBpass: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
          SUPABASE_DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
          SUPABASE_DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
          SUPABASE_DB_USER: ${{ secrets.SUPABASE_DB_USER }}
        run: |
          python scripts/sync_bq_to_supabase.py --project "$PROJECT_ID" --league NFL --append
